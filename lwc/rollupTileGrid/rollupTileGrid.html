<template>
    <section class="st-rollup-grid" onclick={handleRootClick}>
        <!-- Header + Refresh -->
        <template if:true={hasHeaderOrToolbar}>
            <div class="st-rollup-grid__header-row slds-grid slds-grid_align-spread slds-m-bottom_small">
                <div class="st-rollup-grid__header slds-grid slds-grid_vertical-align-center">
                    <template if:true={hasHeader}>
                        <span class="st-rollup-grid__header-text slds-text-heading_small">
                            {headerText}
                        </span>
                        <template if:true={headerHelpText}>
                            <lightning-helptext
                                class="st-rollup-grid__header-help"
                                content={headerHelpText}>
                            </lightning-helptext>
                        </template>
                    </template>
                </div>

                <template if:true={showRefreshButtonEffective}>
                    <lightning-button-icon
                        icon-name="utility:refresh"
                        alternative-text="Refresh rollups"
                        variant="bare"
                        size="small"
                        onclick={handleRefreshAllClick}>
                    </lightning-button-icon>
                </template>
            </div>
        </template>

        <!-- Tiles -->
        <div class="st-rollup-grid__body" style={gridStyle}>
            <template for:each={tiles} for:item="tile">
                <article key={tile.index} class={tileContainerClass}>
                    <!-- Tile header: title + (i) + gear -->
                    <div class="st-rollup-tile__header slds-grid slds-grid_align-spread slds-m-bottom_x-small">
                        <div class="slds-grid slds-grid_vertical-align-center st-rollup-tile__title">
                            <span class="slds-truncate" title={tile.label}>{tile.label}</span>

                            <!-- Small info icon next to title; shows summary text -->
                            <lightning-helptext
                                class="st-rollup-tile__title-help"
                                content={tile.summaryLabel}>
                            </lightning-helptext>
                        </div>

                        <!-- Gear with dropdown -->
                        <div class={tile.gearMenuClass}>
                            <lightning-button-icon
                                data-index={tile.index}
                                icon-name="utility:settings"
                                variant="bare"
                                size="x-small"
                                alternative-text="Change aggregation"
                                title={tile.summaryLabel}
                                onclick={handleGearClick}>
                            </lightning-button-icon>

                            <div class="slds-dropdown slds-dropdown_right">
                                <ul class="slds-dropdown__list" role="menu">
                                    <template for:each={tile.aggregationMenuOptions} for:item="opt">
                                        <li key={opt.value} class={opt.itemClass} role="presentation">
                                            <a
                                                role="menuitemradio"
                                                aria-checked={opt.ariaChecked}
                                                data-index={tile.index}
                                                data-value={opt.value}
                                                onclick={handleAggregationMenuClick}>
                                                <span class="slds-truncate" title={opt.label}>{opt.label}</span>
                                                <template if:true={opt.isSelected}>
                                                    <lightning-icon
                                                        icon-name="utility:check"
                                                        size="x-small"
                                                        class="st-rollup-tile__option-check">
                                                    </lightning-icon>
                                                </template>
                                            </a>
                                        </li>
                                    </template>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Tile body -->
                    <div class="st-rollup-tile__body">
                        <template if:true={tile.isLoading}>
                            <div class="slds-p-vertical_medium slds-grid slds-grid_align-center">
                                <lightning-spinner
                                    alternative-text="Loading rollup"
                                    size="small">
                                </lightning-spinner>
                            </div>
                        </template>

                        <template if:false={tile.isLoading}>
                            <!-- Error (wrap text so it doesnâ€™t get clipped) -->
                            <template if:true={tile.error}>
                                <p
                                    class="st-rollup-tile__error slds-text-color_error"
                                    style="white-space: normal; word-break: break-word;">
                                    {tile.error}
                                </p>
                            </template>

                            <!-- Value + summary -->
                            <template if:false={tile.error}>
                                <div class="st-rollup-tile__value slds-text-heading_medium">
                                    {tile.displayValue}
                                </div>

                                <template if:true={tile.summaryLabel}>
                                    <p class="st-rollup-tile__summary slds-text-body_small">
                                        {tile.summaryLabel}
                                    </p>
                                </template>
                            </template>
                        </template>
                    </div>
                </article>
            </template>
        </div>
    </section>
</template>
